<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Liquid Volume Mixer</title>
<style>
  :root{
    --bg:#0f1112;
    --card:#17181a;
    --muted:#9aa0a6;
    --accent:#3fa7ff;
    --btn:#232529;
    --focus:rgba(63,167,255,0.18);
    --round:12px;
  }

  /* Base */
  html,body { height:100%; margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; color:#eef2f5; background:linear-gradient(180deg,#070708 0%, #0d0f11 100%); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  .app { max-width:820px; margin:18px auto; padding:18px; border-radius:16px; background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.008)); box-shadow:0 10px 40px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.02); }

  /* Header */
  header { display:flex; gap:12px; align-items:center; margin-bottom:12px; padding-bottom:6px; border-bottom:1px solid rgba(255,255,255,0.02); }
  h1 { font-size:30px; margin:0; font-weight:900; letter-spacing:0.2px; color:#fff; }
  p.lead { margin:0; color:var(--muted); font-size:13px; }

  /* Controls */
  .controls { display:flex; gap:10px; align-items:center; margin-top:12px; }
  .field { display:flex; flex-direction:column; gap:6px; }
  label.small { font-size:12px; color:var(--muted); }

  input[type="number"], input[type="text"], select {
    padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.03);
    background:#0b0b0c; color:inherit; font-size:15px;
    min-width:120px;
  }

  /* Parts list */
  .parts { margin-top:14px; display:flex; flex-direction:column; gap:10px; }
  .part {
    display:flex; gap:10px; align-items:center; padding:10px;
    background:var(--card); border-radius:var(--round); border:1px solid rgba(255,255,255,0.02);
  }
  .part .name { flex:1; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.02); background:transparent; color:inherit; font-size:15px; }
  .part .ratio { width:120px; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.02); background:transparent; text-align:center; font-size:15px; }

  .meta { display:flex; gap:8px; align-items:center; }
  .row-btn {
    background:transparent; border:1px solid rgba(255,255,255,0.03); color:var(--muted);
    width:44px; height:44px; display:inline-grid; place-content:center; border-radius:10px; font-weight:700;
  }
  .row-btn:active { transform: translateY(1px); }

  /* Result */
  .result { margin-top:16px; padding:12px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border:1px solid rgba(255,255,255,0.02); }
  .result-list { display:flex; flex-direction:column; gap:8px; }
  .result-row { display:flex; justify-content:space-between; align-items:center; }
  .small { font-size:13px; color:var(--muted); }

  /* Footer actions */
  .actions { display:flex; gap:10px; margin-top:12px; align-items:center; }
  .btn-primary { background:linear-gradient(90deg,var(--accent), #2fa0ff); color:#02101a; border:none; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; min-width:120px; box-shadow:0 6px 18px rgba(47,160,255,0.12); }
  .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.03); color:var(--muted); padding:10px 12px; border-radius:12px; font-weight:700; cursor:pointer; }

  /* Responsive / mobile-first */
  @media (max-width:640px) {
    .controls { flex-direction:column; align-items:stretch; }
    .controls > * { width:100%; }
    .part { flex-direction:column; align-items:stretch; gap:8px; }
    .part .ratio { width:100%; }
    .meta { justify-content:flex-end; }
    .actions { flex-direction:column; align-items:stretch; }
    .btn-primary, .btn-ghost { width:100%; }
    h1 { font-size:32px; text-align:center; }
    header { flex-direction:column; align-items:center; gap:6px; }
  }

  /* Focus */
  input:focus, select:focus, button:focus { outline:2px solid var(--focus); outline-offset:2px; }
</style>
</head>
<body>
  <main class="app" role="main" aria-labelledby="title">
    <header>
      <div style="flex:1">
        <h1 id="title">Liquid Volume Mixer</h1>
        <p class="lead">Distribute a target volume among parts using ratios. Totals always match exactly.</p>
      </div>
    </header>

    <section class="controls" aria-label="Controls">
      <div class="field" style="flex:1">
        <label class="small" for="finalVolume">Final volume</label>
        <div style="display:flex;gap:8px">
          <input id="finalVolume" type="number" inputmode="decimal" min="0" value="1000" />
          <select id="unit" aria-label="Unit">
            <option value="ml">ml</option>
            <option value="l">L</option>
          </select>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button id="addPartBtn" class="btn-primary" onclick="addPart()" title="Add part">+ Add part</button>
        <button id="clearBtn" class="btn-ghost" onclick="clearParts()">Clear</button>
      </div>
    </section>

    <section class="parts" id="parts" aria-label="Parts"></section>

    <div class="result" id="result" aria-live="polite">
      <div class="small">Add parts and tap Calculate.</div>
    </div>

    <div class="actions">
      <button class="btn-primary" onclick="calculate()">Calculate</button>
      <button class="btn-ghost" onclick="copyResult()">Copy result</button>
      <div style="margin-left:auto" class="small">Total ratio: <strong id="totalRatio">0</strong></div>
    </div>
  </main>

<script>
/* Mobile-friendly simplified mixer
 - Same color scheme, simplified layout and controls
 - Largest remainder integer allocation (ml) to guarantee totals
 - Touch-friendly controls and full-width actions on small screens
 - Local persistence of parts (auto-save)
*/

const STORAGE_KEY = 'mixer:state:v1';
let partIndex = 0;

function saveState(){
  const parts = [...document.querySelectorAll('.part')].map(p => ({
    name: p.querySelector('.name').value.trim(),
    ratio: Number(p.querySelector('.ratio').value) || 0
  }));
  const state = {
    finalVolume: Number(document.getElementById('finalVolume').value) || 0,
    unit: document.getElementById('unit').value,
    parts
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return false;
  try{
    const s = JSON.parse(raw);
    document.getElementById('finalVolume').value = s.finalVolume ?? 1000;
    document.getElementById('unit').value = s.unit ?? 'ml';
    clearParts(false);
    (s.parts || []).forEach(p => addPart(p.name || undefined, p.ratio || 1));
    return true;
  }catch(e){ return false; }
}

function defaultPartName(i){
  const A = 65;
  if(i < 26) return 'Part ' + String.fromCharCode(A + i);
  const idx = i % 26;
  const suffix = Math.floor(i/26);
  return 'Part ' + String.fromCharCode(A + idx) + suffix;
}

function addPart(name, ratio){
  const parts = document.getElementById('parts');
  const i = partIndex++;
  const part = document.createElement('div');
  part.className = 'part';
  part.innerHTML = `
    <input class="name" type="text" value="${(name ?? defaultPartName(i)).replace(/"/g,'&quot;')}" aria-label="Part name">
    <input class="ratio" type="number" min="0" step="any" value="${(ratio ?? 1)}" aria-label="Ratio">
    <div class="meta">
      <button class="row-btn" title="Move up" aria-label="Move up">▲</button>
      <button class="row-btn" title="Move down" aria-label="Move down">▼</button>
      <button class="row-btn" title="Remove part" aria-label="Remove part">✕</button>
    </div>
  `;
  parts.appendChild(part);

  const nameInput = part.querySelector('.name');
  const ratioInput = part.querySelector('.ratio');
  nameInput.addEventListener('input', onChange);
  ratioInput.addEventListener('input', onChange);
  part.querySelectorAll('.row-btn')[0].addEventListener('click', ()=>movePart(part, -1));
  part.querySelectorAll('.row-btn')[1].addEventListener('click', ()=>movePart(part, 1));
  part.querySelectorAll('.row-btn')[2].addEventListener('click', ()=>{ part.remove(); onChange(); });

  onChange();
  return part;
}

function movePart(part, dir){
  const parent = part.parentElement;
  if(!parent) return;
  const items = [...parent.children];
  const idx = items.indexOf(part);
  const newIdx = Math.max(0, Math.min(items.length-1, idx + dir));
  if(newIdx === idx) return;
  parent.removeChild(part);
  if(newIdx >= parent.children.length) parent.appendChild(part);
  else parent.insertBefore(part, parent.children[newIdx]);
  onChange();
}

function clearParts(save = true){
  document.getElementById('parts').innerHTML = '';
  partIndex = 0;
  if(save) onChange();
}

function onChange(){
  updateTotals();
  saveState();
}

function calculate(){
  const parts = [...document.querySelectorAll('.part')];
  const finalVolumeRaw = Number(document.getElementById('finalVolume').value) || 0;
  const unit = document.getElementById('unit').value;
  if(parts.length === 0){
    renderMessage('Add at least one part.');
    return;
  }
  const items = parts.map(p => ({
    name: p.querySelector('.name').value || 'Part',
    ratio: parseFloat(p.querySelector('.ratio').value) || 0
  })).filter(x => x.ratio > 0);
  if(items.length === 0){
    renderMessage('At least one part must have a ratio > 0.');
    return;
  }

  let finalVolumeMl = finalVolumeRaw;
  if(unit === 'l') finalVolumeMl = finalVolumeRaw * 1000;
  if(finalVolumeMl <= 0){
    renderMessage('Final volume must be > 0.');
    return;
  }

  const totalRatio = items.reduce((s,i)=>s+i.ratio,0);
  const exactVolumes = items.map(i => (finalVolumeMl * i.ratio / totalRatio));

  // Largest remainder integer allocation (ml)
  const floored = exactVolumes.map(v => Math.floor(v));
  let sumFloor = floored.reduce((a,b)=>a+b,0);
  let remainder = Math.round(finalVolumeMl - sumFloor);
  const fractions = exactVolumes.map((v, idx)=>({idx, frac: v - Math.floor(v)}));
  fractions.sort((a,b)=>b.frac - a.frac);
  const allocated = [...floored];
  let k = 0;
  while(remainder > 0 && k < fractions.length){
    allocated[fractions[k].idx] += 1;
    remainder--;
    k++;
    if(k === fractions.length && remainder > 0) k = 0;
  }

  const displayVolumes = allocated.map(v => unit === 'ml' ? v : v/1000);
  renderResult(items, displayVolumes, unit, finalVolumeRaw, totalRatio);
  saveState();
}

function renderResult(items, displayVolumes, unit, finalVolumeRaw, totalRatio){
  const r = document.getElementById('result');
  r.innerHTML = '';
  const list = document.createElement('div'); list.className = 'result-list';
  items.forEach((it, idx) => {
    const v = displayVolumes[idx];
    const percent = (it.ratio / totalRatio) * 100;
    const row = document.createElement('div'); row.className = 'result-row';
    row.innerHTML = `<div><strong>${escapeHtml(it.name)}</strong> <span class="small">(${percent.toFixed(1)}%)</span></div>
                     <div class="small">${formatVolume(v, unit)}</div>`;
    list.appendChild(row);
  });
  r.appendChild(list);

  const hr = document.createElement('hr'); hr.style.border='none'; hr.style.height='1px'; hr.style.margin='8px 0'; hr.style.background='rgba(255,255,255,0.03)';
  r.appendChild(hr);
  const tot = document.createElement('div'); tot.className = 'result-row';
  tot.innerHTML = `<div class="small"><strong>Total</strong></div><div><strong>${formatVolume(unit === 'ml' ? finalVolumeRaw : (finalVolumeRaw), unit)}</strong></div>`;
  r.appendChild(tot);

  r.dataset.text = items.map((it, idx)=> `${it.name}: ${formatVolume(displayVolumes[idx], unit)} (${(it.ratio/totalRatio*100).toFixed(1)}%)`).join('\n');
}

function formatVolume(v, unit){
  if(unit === 'ml'){ return `${Math.round(v)} ml`; }
  const s = Number(v).toFixed(3).replace(/\.?0+$/, '');
  return `${s} L`;
}

function renderMessage(msg){
  const r = document.getElementById('result');
  r.innerHTML = `<div class="small">${escapeHtml(msg)}</div>`;
  delete r.dataset.text;
}

function copyResult(){
  const r = document.getElementById('result');
  const txt = r.dataset.text;
  if(!txt){ alert('Nothing to copy. Calculate first.'); return; }
  navigator.clipboard?.writeText(txt).then(()=>{ alert('Copied to clipboard'); }, ()=>{ alert('Copy failed'); });
}

function updateTotals(){
  const rows = [...document.querySelectorAll('.part')];
  const ratios = rows.map(r => parseFloat(r.querySelector('.ratio').value) || 0);
  const total = ratios.reduce((a,b)=>a+b,0);
  document.getElementById('totalRatio').textContent = total ? total : 0;
}

function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

/* Init */
(function init(){
  if(!loadState()){
    addPart('Part A', 1);
    addPart('Part B', 1);
  }
  document.getElementById('finalVolume').addEventListener('input', onChange);
  document.getElementById('unit').addEventListener('change', onChange);
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') calculate(); });
  updateTotals();
})();
</script>
</body>
</html>
